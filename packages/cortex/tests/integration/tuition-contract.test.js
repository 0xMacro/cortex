import o from 'ospec'
import { EVM, generateFlowCode, createTestFlow } from '../_test-helper.js'
import { createFlow } from '../../index.js'

o.spec('Integration: Tuition', () => {
  o.specTimeout(750)

  let evm, contract, owner, treasury, staff, student;
  let flow;
  o.beforeEach(async () => {
    evm = new EVM()
    await evm.init()

    ;[owner, treasury, staff, student] = evm.accounts

    contract = await evm.deploy(bytecode, ['address', 'address', 'address[]'], [owner.address, treasury.address, []])

    const flowCode = generateFlowCode('tuition-contract.pl', { contractAddr: contract })

    flow = await createTestFlow(flowCode)
  })

  async function promptExists(query, count=1) {
    count =
      count === true ? 1 :
      count === false ? 0 :
      count
    o(await flow.promptCount(query)).equals(count)
  }

  async function effectExists(query, count=1) {
    count =
      count === true ? 1 :
      count === false ? 0 :
      count
    o(await flow.effectCount(query)).equals(count)
  }

  o('Detects staff', async () => {
    await flow.init(staff.address, 10, { signer: staff })
    await promptExists(`button('Owner', _, _)`)
    await promptExists(`text('You are staff')`, false)
    await promptExists(`text('You are not staff')`)

    // Update state, then ensure prompt changed
    await owner.call(contract, 'manageStaff(address,bool)', [staff.address, true])
    o(await owner.get(contract, 'isStaff(address): bool', [staff.address])).deepEquals([true]) // Sanity check

    flow.setBlockNumber(11)

    await promptExists(`button('Owner', _, _)`)
    await promptExists(`text('You are staff')`)
    await promptExists(`text('You are not staff')`, false)
  })

  o('Detects non-staff non-admin', async () => {
    await flow.init(student.address, 10, { signer: student })
    await promptExists(`button('Pay Deposit', _, _)`)

    const [{ Actions }] = await flow.matchPrompts(`button('Pay Deposit', _, Actions)`, 'Actions')
    await flow.execute(Actions)

    flow.setBlockNumber(11)

    await promptExists(`button('Pay Deposit', _, _)`, false)
    await promptExists(`text('Congratulations! Your deposit has been registered.')`)
  })

  o('Gets owner address', async () => {
    await flow.init(staff.address, 10, { signer: staff })
    const [{ Actions }] = await flow.matchPrompts(`button('Owner', _, Actions)`, 'Actions')
    // console.log("Executing", Actions)

    const result = await flow.execute(Actions)
    o(result.effects[0]).deepEquals(['log', 'notice', ['text', "'Owner address: '", `'${owner.address}'`]])

    await effectExists(`log(notice, text(_, '${owner.address}'))`)
  })
})

const bytecode = '0x60806040523480156200001157600080fd5b506040516200205a3803806200205a833981810160405281019062000037919062000433565b620000576200004b6200016f60201b60201c565b6200017760201b60201c565b60005b81518110156200011357600160026000848481518110620000a4577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001015173ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff02191690831515021790555080806200010a9062000611565b9150506200005a565b5081600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555062000166836200023b60201b60201c565b50505062000760565b600033905090565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050816000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508173ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a35050565b6200024b6200016f60201b60201c565b73ffffffffffffffffffffffffffffffffffffffff16620002716200035160201b60201c565b73ffffffffffffffffffffffffffffffffffffffff1614620002ca576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401620002c19062000512565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1614156200033d576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016200033490620004f0565b60405180910390fd5b6200034e816200017760201b60201c565b50565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b6000620003916200038b846200055d565b62000534565b90508083825260208201905082856020860282011115620003b157600080fd5b60005b85811015620003e55781620003ca8882620003ef565b845260208401935060208301925050600181019050620003b4565b5050509392505050565b600081519050620004008162000746565b92915050565b600082601f8301126200041857600080fd5b81516200042a8482602086016200037a565b91505092915050565b6000806000606084860312156200044957600080fd5b60006200045986828701620003ef565b93505060206200046c86828701620003ef565b925050604084015167ffffffffffffffff8111156200048a57600080fd5b620004988682870162000406565b9150509250925092565b6000620004b16026836200058c565b9150620004be82620006ce565b604082019050919050565b6000620004d86020836200058c565b9150620004e5826200071d565b602082019050919050565b600060208201905081810360008301526200050b81620004a2565b9050919050565b600060208201905081810360008301526200052d81620004c9565b9050919050565b60006200054062000553565b90506200054e8282620005db565b919050565b6000604051905090565b600067ffffffffffffffff8211156200057b576200057a6200068e565b5b602082029050602081019050919050565b600082825260208201905092915050565b6000620005aa82620005b1565b9050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b620005e682620006bd565b810181811067ffffffffffffffff821117156200060857620006076200068e565b5b80604052505050565b60006200061e82620005d1565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8214156200065457620006536200065f565b5b600182019050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6000601f19601f8301169050919050565b7f4f776e61626c653a206e6577206f776e657220697320746865207a65726f206160008201527f6464726573730000000000000000000000000000000000000000000000000000602082015250565b7f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e6572600082015250565b62000751816200059d565b81146200075d57600080fd5b50565b6118ea80620007706000396000f3fe6080604052600436106100dd5760003560e01c8063a78e5b9b1161007f578063d7bb99ba11610059578063d7bb99ba14610298578063e3d670d7146102a2578063e7abb79a146102df578063f2fde38b146102f6576100dd565b8063a78e5b9b14610207578063cb510e9714610230578063cf3090121461026d576100dd565b806372b38ab9116100bb57806372b38ab914610161578063864259511461018a5780638da5cb5b146101b3578063a6f353f0146101de576100dd565b80631f3d793e146100e25780632d2c55651461011f578063715018a61461014a575b600080fd5b3480156100ee57600080fd5b50610109600480360381019061010491906112a6565b61031f565b60405161011691906114e9565b60405180910390f35b34801561012b57600080fd5b5061013461033f565b60405161014191906114ce565b60405180910390f35b34801561015657600080fd5b5061015f610365565b005b34801561016d57600080fd5b50610188600480360381019061018391906112a6565b6103ed565b005b34801561019657600080fd5b506101b160048036038101906101ac91906112a6565b6107a6565b005b3480156101bf57600080fd5b506101c8610b81565b6040516101d591906114ce565b60405180910390f35b3480156101ea57600080fd5b50610205600480360381019061020091906112a6565b610baa565b005b34801561021357600080fd5b5061022e600480360381019061022991906112cf565b610c6a565b005b34801561023c57600080fd5b50610257600480360381019061025291906112a6565b610d41565b60405161026491906114e9565b60405180910390f35b34801561027957600080fd5b50610282610d61565b60405161028f91906114e9565b60405180910390f35b6102a0610d74565b005b3480156102ae57600080fd5b506102c960048036038101906102c491906112a6565b610f39565b6040516102d69190611644565b60405180910390f35b3480156102eb57600080fd5b506102f4610f51565b005b34801561030257600080fd5b5061031d600480360381019061031891906112a6565b6110b8565b005b60036020528060005260406000206000915054906101000a900460ff1681565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b61036d6111b0565b73ffffffffffffffffffffffffffffffffffffffff1661038b610b81565b73ffffffffffffffffffffffffffffffffffffffff16146103e1576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016103d8906115e4565b60405180910390fd5b6103eb60006111b8565b565b600260003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16806104775750610448610b81565b73ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16145b6104b6576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016104ad90611524565b60405180910390fd5b600160149054906101000a900460ff1615610506576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016104fd90611544565b60405180910390fd5b600360008273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16610592576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161058990611504565b60405180910390fd5b6000600460008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205411610614576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161060b906115a4565b60405180910390fd5b6000600460008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205490506000600460008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055506000600360008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff02191690831515021790555060008273ffffffffffffffffffffffffffffffffffffffff168260405161071b906114b9565b60006040518083038185875af1925050503d8060008114610758576040519150601f19603f3d011682016040523d82523d6000602084013e61075d565b606091505b50509050806107a1576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610798906115c4565b60405180910390fd5b505050565b600260003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16806108305750610801610b81565b73ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16145b61086f576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161086690611524565b60405180910390fd5b600160149054906101000a900460ff16156108bf576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016108b690611544565b60405180910390fd5b600360008273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff1661094b576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161094290611504565b60405180910390fd5b6000600460008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054116109cd576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016109c490611584565b60405180910390fd5b6000600460008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205490506000600460008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055506000600360008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055506000600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1682604051610af6906114b9565b60006040518083038185875af1925050503d8060008114610b33576040519150601f19603f3d011682016040523d82523d6000602084013e610b38565b606091505b5050905080610b7c576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610b73906115c4565b60405180910390fd5b505050565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b610bb26111b0565b73ffffffffffffffffffffffffffffffffffffffff16610bd0610b81565b73ffffffffffffffffffffffffffffffffffffffff1614610c26576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610c1d906115e4565b60405180910390fd5b80600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b610c726111b0565b73ffffffffffffffffffffffffffffffffffffffff16610c90610b81565b73ffffffffffffffffffffffffffffffffffffffff1614610ce6576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610cdd906115e4565b60405180910390fd5b80600260008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055505050565b60026020528060005260406000206000915054906101000a900460ff1681565b600160149054906101000a900460ff1681565b600160149054906101000a900460ff1615610dc4576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610dbb90611544565b60405180910390fd5b600360003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff1615610e51576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610e4890611604565b60405180910390fd5b670de0b6b3a76400003414610e9b576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610e9290611624565b60405180910390fd5b6001600360003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff02191690831515021790555034600460003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550565b60046020528060005260406000206000915090505481565b610f596111b0565b73ffffffffffffffffffffffffffffffffffffffff16610f77610b81565b73ffffffffffffffffffffffffffffffffffffffff1614610fcd576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610fc4906115e4565b60405180910390fd5b60018060146101000a81548160ff0219169083151502179055506000600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff164760405161102f906114b9565b60006040518083038185875af1925050503d806000811461106c576040519150601f19603f3d011682016040523d82523d6000602084013e611071565b606091505b50509050806110b5576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016110ac906115c4565b60405180910390fd5b50565b6110c06111b0565b73ffffffffffffffffffffffffffffffffffffffff166110de610b81565b73ffffffffffffffffffffffffffffffffffffffff1614611134576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161112b906115e4565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1614156111a4576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161119b90611564565b60405180910390fd5b6111ad816111b8565b50565b600033905090565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050816000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508173ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a35050565b60008135905061128b81611886565b92915050565b6000813590506112a08161189d565b92915050565b6000602082840312156112b857600080fd5b60006112c68482850161127c565b91505092915050565b600080604083850312156112e257600080fd5b60006112f08582860161127c565b925050602061130185828601611291565b9150509250929050565b6113148161167b565b82525050565b6113238161168d565b82525050565b600061133660118361166a565b9150611341826116c3565b602082019050919050565b6000611359600a8361166a565b9150611364826116ec565b602082019050919050565b600061137c60138361166a565b915061138782611715565b602082019050919050565b600061139f60268361166a565b91506113aa8261173e565b604082019050919050565b60006113c260128361166a565b91506113cd8261178d565b602082019050919050565b60006113e560118361166a565b91506113f0826117b6565b602082019050919050565b6000611408600f8361166a565b9150611413826117df565b602082019050919050565b600061142b60208361166a565b915061143682611808565b602082019050919050565b600061144e60008361165f565b915061145982611831565b600082019050919050565b6000611471600c8361166a565b915061147c82611834565b602082019050919050565b6000611494600c8361166a565b915061149f8261185d565b602082019050919050565b6114b3816116b9565b82525050565b60006114c482611441565b9150819050919050565b60006020820190506114e3600083018461130b565b92915050565b60006020820190506114fe600083018461131a565b92915050565b6000602082019050818103600083015261151d81611329565b9050919050565b6000602082019050818103600083015261153d8161134c565b9050919050565b6000602082019050818103600083015261155d8161136f565b9050919050565b6000602082019050818103600083015261157d81611392565b9050919050565b6000602082019050818103600083015261159d816113b5565b9050919050565b600060208201905081810360008301526115bd816113d8565b9050919050565b600060208201905081810360008301526115dd816113fb565b9050919050565b600060208201905081810360008301526115fd8161141e565b9050919050565b6000602082019050818103600083015261161d81611464565b9050919050565b6000602082019050818103600083015261163d81611487565b9050919050565b600060208201905061165960008301846114aa565b92915050565b600081905092915050565b600082825260208201905092915050565b600061168682611699565b9050919050565b60008115159050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b7f53545544454e545f4449444e545f504159000000000000000000000000000000600082015250565b7f53544146465f4f4e4c5900000000000000000000000000000000000000000000600082015250565b7f4e4f545f54414b494e475f5041594d454e545300000000000000000000000000600082015250565b7f4f776e61626c653a206e6577206f776e657220697320746865207a65726f206160008201527f6464726573730000000000000000000000000000000000000000000000000000602082015250565b7f4e4f5f46554e44535f415641494c41424c450000000000000000000000000000600082015250565b7f4e4f5448494e475f544f5f524546554e44000000000000000000000000000000600082015250565b7f5452414e534645525f4641494c45440000000000000000000000000000000000600082015250565b7f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e6572600082015250565b50565b7f414c52454144595f504149440000000000000000000000000000000000000000600082015250565b7f57524f4e475f414d4f554e540000000000000000000000000000000000000000600082015250565b61188f8161167b565b811461189a57600080fd5b50565b6118a68161168d565b81146118b157600080fd5b5056fea26469706673582212202b1208bb284f608403323bd5e1fea1770697f1068bcba52a1a29e5ecdbe48eaa64736f6c63430008040033'
